version: '3.8'

services:
  # Blue 환경 (Prod)
  app-blue:
    image: ${DOCKERHUB_USERNAME}/kiero:${BLUE_TAG:-latest}
    container_name: kiero-prod-app-blue
    ports:
      - "8080:8080"
    env_file:
      - .env.prod
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - TZ=Asia/Seoul
      - JAVA_OPTS=-Xms1024m -Xmx2048m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
    networks:
      - app-network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"  # Prod는 로그 보관 용량 증설
        max-file: "10"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'     # 안정성을 위해 최소 보장 CPU 할당
          memory: 1G

  # Green 환경 (Prod)
  app-green:
    image: ${DOCKERHUB_USERNAME}/kiero:${GREEN_TAG:-latest}
    container_name: kiero-prod-app-green
    ports:
      - "8081:8080"
    env_file:
      - .env.prod
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - TZ=Asia/Seoul
      - JAVA_OPTS=-Xms1024m -Xmx2048m -XX:+UseG1GC -XX:MaxGCPauseMillis=200
    networks:
      - app-network
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G

  # Redis
  redis:
    image: redis:7-alpine
    container_name: kiero-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - app-network
    restart: always
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: kiero-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - app-network
    restart: always

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: kiero-grafana
    ports:
      - "3000:3000"
    volumes:
      - grafana-data:/var/lib/grafana
    environment:
      - TZ=Asia/Seoul
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    depends_on:
      - prometheus
    networks:
      - app-network
    restart: always

  # NocoDB
  nocodb:
    image: nocodb/nocodb:latest
    container_name: kiero-nocodb
    ports:
      - "9001:8080"
    environment:
      - NC_DB=mysql2://${NOCODB_DB_HOST}:3306?u=${DB_USERNAME}&p=${DB_PASSWORD}&d=${NOCODB_DB_NAME}
      - NC_AUTH_JWT_SECRET=${NOCODB_JWT_SECRET:-nocodb-jwt-secret-change-me}
      - NC_ADMIN_EMAIL=${NOCODB_ADMIN_EMAIL}
      - NC_ADMIN_PASSWORD=${NOCODB_ADMIN_PASSWORD}
      - TZ=Asia/Seoul
    volumes:
      - nocodb-data:/usr/app/data
    networks:
      - app-network
    restart: always

networks:
  app-network:
    driver: bridge

volumes:
  redis-data:
  prometheus-data:
  grafana-data:
  nocodb-data: